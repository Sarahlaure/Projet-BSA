library(readxl)
library(dplyr)
library(leaflet)
library(lubridate)

# 📂 Charger le fichier Excel
df <- read_excel("www/fusionacled.xlsx") %>%
  mutate(
    date_start = as.Date(date_start, format = "%m/%d/%Y"),
    latitude = as.numeric(latitude),
    longitude = as.numeric(longitude),
    best_est = as.numeric(best_est),
    deaths_civilians = as.numeric(deaths_civilians),
    type_of_violence = as.numeric(type_of_violence)
  )

# 🧪 Tester les filtres
df_filtré <- df %>%
  filter(
    country %in% c("Niger", "Mali"),
    type_of_violence %in% c(1, 2, 3),
    date_start >= as.Date("2018-01-01"),
    date_start <= as.Date("2023-12-31"),
    best_est >= 1
  )

# 🗺️ Affichage sur carte Leaflet
leaflet(data = df_filtré) %>%
  addProviderTiles("CartoDB.Positron") %>%
  addCircleMarkers(
    lng = ~longitude,
    lat = ~latitude,
    radius = ~sqrt(best_est + 1),
    color = "#e74c3c",
    fillOpacity = 0.6,
    stroke = FALSE,
    popup = ~paste0(
      "<b>Conflit :</b> ", conflict_name, "<br/>",
      "<b>Date :</b> ", date_start, "<br/>",
      "<b>Type :</b> ", type_of_violence, "<br/>",
      "<b>Dyade :</b> ", dyad_name, "<br/>",
      "<b>Morts estimées :</b> ", best_est
    )
  )
